{% extends 'base.html' %}

{% block head %}
<style>
    /* Tailwind CSS classes are used for styling, ensure Tailwind is configured */
    #whiteboard {
        border: 2px solid #4c1d95; /* violet-800 */
        border-radius: 0.75rem;
        cursor: crosshair;
        touch-action: none; /* Important for mobile: Prevents scrolling while drawing */
        /* Set initial background to black/dark for contrast */
        background-color: #0f172a; /* slate-900 */
    }
    .color-swatch {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: border-color 0.2s;
    }
    .color-swatch.active {
        border-color: #a78bfa; /* violet-400 */
    }

    /* Style for the uploaded image in chat */
    .chat-image {
        max-width: 100%;
        max-height: 250px;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        display: block;
    }

    /* REMOVED: .whiteboard-modal-transition is no longer needed for a direct open/close */
    /* If you want the fade effect back, you'll need the JS transition logic from the previous reply */
</style>
{% endblock %}

{% block content %}
<div class="w-full max-w-7xl mx-auto py-6">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-violet-300">Project War Room: {{ post.event_name }}</h1>
        <p class="text-lg text-violet-400">Chat with your team and brainstorm ideas in real-time.</p>
    </div>

    <div class="flex justify-center">
        <div class="hidden md:flex flex-col w-80 max-w-xs bg-slate-800/50 border border-violet-900/60 rounded-2xl mr-6 h-[700px] p-6">
            <h2 class="text-xl font-bold text-violet-300 mb-4">To-Do List</h2>
            <div class="mb-4">
                <div class="w-full bg-slate-700 rounded-full h-4 mb-2">
                    <div id="todo-progress-bar" class="bg-violet-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <span id="todo-progress-text" class="text-sm text-violet-200">0% complete</span>
            </div>
            <ul id="todo-list" class="space-y-3 flex-1 overflow-y-auto mb-4">
            </ul>
            <form id="todo-form" class="flex gap-2 mt-auto">
                <input id="todo-input" type="text" placeholder="Add a task..." class="flex-grow px-3 py-2 rounded-lg border border-violet-800 bg-black/40 text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-500 transition">
                <button type="submit" class="px-4 py-2 bg-violet-700 hover:bg-violet-600 text-white font-bold rounded-lg shadow-md transition-colors">Add</button>
            </form>
        </div>

        <div class="w-full max-w-4xl bg-slate-800/50 border border-violet-900/60 rounded-2xl flex flex-col h-[700px]">
            <div id="messages" class="flex-grow p-6 space-y-4 overflow-y-auto">
                {% for msg in messages %}
                <div class="flex items-start gap-3 {% if msg.sender_id == current_user.id %}flex-row-reverse{% endif %}">
                    <a href="{{ url_for('user', username=msg.sender.username) }}">
                        <img src="{{ msg.sender.profile.avatar_url }}" alt="{{ msg.sender.username }}'s avatar" class="w-10 h-10 rounded-full">
                    </a>
                    <div class="max-w-xs md:max-w-md">
                        <p class="text-sm font-bold text-violet-200 mb-1 {% if msg.sender_id == current_user.id %}text-right{% else %}text-left{% endif %}">
                            {{ msg.sender.username }}
                        </p>
                        <div class="p-3 rounded-lg {% if msg.sender_id == current_user.id %}bg-violet-700 text-white{% else %}bg-slate-700 text-violet-200{% endif %}">
                            {% if msg.content and msg.content.startswith('data:image/') %}
                                <img src="{{ msg.content }}" class="chat-image" alt="Uploaded Image">
                            {% else %}
                                <p class="text-sm">{{ msg.content }}</p>
                            {% endif %}
                        </div>
                        <span class="text-xs text-violet-400 mt-1 block {% if msg.sender_id == current_user.id %}text-right{% else %}text-left{% endif %}">
                            {{ msg.timestamp.strftime('%b %d, %I:%M %p') }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="p-4 border-t border-violet-900/60">
                <form id="message-form" class="flex items-center gap-4">
                    <input type="file" id="file-upload" accept="image/*" class="hidden">

                    <input id="content-input" type="text" placeholder="Type your message..." autocomplete="off" class="flex-grow px-4 py-2 rounded-lg border border-violet-800 bg-black/40 text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-500 transition">

                    <button id="upload-photo-btn" type="button" title="Upload Photo" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg shadow-md transition-colors focus-ring">
                        ðŸ–¼
                    </button>
                    <button id="open-whiteboard-btn" type="button" title="Open Whiteboard" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg shadow-md transition-colors focus-ring">
                        ðŸŽ¨
                    </button>
                    <button id="send-button" type="submit" class="px-6 py-2 bg-violet-700 hover:bg-violet-600 text-white font-bold rounded-lg shadow-md transition-colors focus-ring">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="whiteboard-modal" class="hidden fixed inset-0 bg-black/75 flex items-center justify-center z-50 p-4">
    <div id="whiteboard-container" class="bg-slate-800/90 border border-violet-700 rounded-2xl p-6 flex flex-col w-full max-w-6xl h-[95vh] relative shadow-2xl">
        <button id="close-whiteboard-btn" class="absolute top-2 right-4 text-4xl text-violet-300 hover:text-white font-light z-10 leading-none" title="Close Whiteboard">&times;</button>

        <div class="mb-4 p-3 bg-slate-900/60 rounded-xl flex items-center justify-center gap-6 shadow-inner">
            <span class="text-violet-300 font-semibold text-lg">Drawing Tools:</span>

            <div class="flex gap-3">
                <div class="color-swatch active" style="background-color: #f5f5f5;" data-color="#f5f5f5" title="White"></div>
                <div class="color-swatch" style="background-color: #ef4444;" data-color="#ef4444" title="Red"></div>
                <div class="color-swatch" style="background-color: #3b82f6;" data-color="#3b82f6" title="Blue"></div>
                <div class="color-swatch" style="background-color: #22c55e;" data-color="#22c55e" title="Green"></div>
                <div class="color-swatch" style="background-color: #f97316;" data-color="#f97316" title="Orange"></div>
                <div class="color-swatch" style="background-color: #8b5cf6;" data-color="#8b5cf6" title="Violet"></div>
            </div>

            <button id="clear-btn" class="ml-auto px-5 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-base shadow-lg transition-colors">Clear Board</button>
        </div>

        <div class="flex-grow w-full h-full min-h-0">
             <canvas id="whiteboard" class="w-full h-full"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Shared Setup ---
    const postId = {{ post.id|tojson }};
    const currentUserId = {{ current_user.id|tojson }};
    // Ensure the socket connects to the correct namespace
    const socket = io('/chat');

    // =================================================================
    // ### TO-DO LIST LOGIC ### (Local Storage Based)
    // =================================================================
    const todoList = document.getElementById('todo-list');
    const todoForm = document.getElementById('todo-form');
    const todoInput = document.getElementById('todo-input');
    const todoProgressBar = document.getElementById('todo-progress-bar');
    const todoProgressText = document.getElementById('todo-progress-text');

    const todoKey = chat_todos_${postId};
    let todos = JSON.parse(localStorage.getItem(todoKey) || '[]');

    function renderTodos() {
        todoList.innerHTML = '';
        let completed = 0;
        todos.forEach((todo, idx) => {
            const li = document.createElement('li');
            li.className = 'flex items-center gap-2 bg-slate-700 rounded-lg px-3 py-2';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!todo.done;
            checkbox.className = 'accent-violet-500 w-5 h-5';
            checkbox.addEventListener('change', () => {
                todos[idx].done = checkbox.checked;
                saveTodos();
                renderTodos();
            });
            if (todo.done) completed++;
            const span = document.createElement('span');
            span.textContent = todo.text;
            span.className = 'flex-1 ' + (todo.done ? 'line-through text-violet-400' : 'text-violet-100');
            const delBtn = document.createElement('button');
            delBtn.innerHTML = '&times;';
            delBtn.className = 'ml-2 text-red-400 hover:text-red-600 text-lg font-bold';
            delBtn.title = 'Delete';
            delBtn.addEventListener('click', () => {
                todos.splice(idx, 1);
                saveTodos();
                renderTodos();
            });
            li.appendChild(checkbox);
            li.appendChild(span);
            li.appendChild(delBtn);
            todoList.appendChild(li);
        });
        const percent = todos.length ? Math.round((completed / todos.length) * 100) : 0;
        todoProgressBar.style.width = percent + '%';
        todoProgressText.textContent = percent + '% complete';
    }
    function saveTodos() {
        localStorage.setItem(todoKey, JSON.stringify(todos));
    }
    todoForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = todoInput.value.trim();
        if (text) {
            todos.push({ text, done: false });
            saveTodos();
            renderTodos();
            todoInput.value = '';
        }
    });
    renderTodos();

    // =================================================================
    // ### CHAT LOGIC ###
    // =================================================================
    const messagesDiv = document.getElementById('messages');
    const messageForm = document.getElementById('message-form');
    const contentInput = document.getElementById('content-input');

    // Scroll to bottom on load
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // Helper function to format timestamp
    function formatTimestamp(date) {
        const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleTimeString([], options);
    }

    // Helper function to create message HTML
    function createMessageHtml(data, isSelf) {
        const content = data.content || '';
        const isImage = content.startsWith('data:image/');
        const contentBody = isImage
            ? <img src="${content}" class="chat-image" alt="Uploaded Image">
            : <p class="text-sm">${content}</p>;

        const username = data.username || '{{ current_user.username }}';
        const avatarUrl = data.avatar_url || '{{ current_user.profile.avatar_url }}';
        const timestamp = data.timestamp;

        return `
            <div class="flex items-start gap-3 ${isSelf ? 'flex-row-reverse' : ''}">
                <a href="/user/${username}">
                    <img src="${avatarUrl}" alt="${username}'s avatar" class="w-10 h-10 rounded-full">
                </a>
                <div class="max-w-xs md:max-w-md">
                    <p class="text-sm font-bold text-violet-200 mb-1 ${isSelf ? 'text-right' : 'text-left'}">${username}</p>
                    <div class="p-3 rounded-lg ${isSelf ? 'bg-violet-700 text-white' : 'bg-slate-700 text-violet-200'}">
                        ${contentBody}
                    </div>
                    <span class="text-xs text-violet-400 mt-1 block ${isSelf ? 'text-right' : 'text-left'}">
                        ${timestamp}
                    </span>
                </div>
            </div>`;
    }

    socket.on('connect', () => {
        socket.emit('join', { post_id: postId });
    });

    socket.on('receive_message', (data) => {
        // Only render messages from others, as sender renders locally
        if (data.sender_id == currentUserId) {
            return;
        }

        messagesDiv.innerHTML += createMessageHtml(data, false);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const content = contentInput.value.trim();

        if (content) {
            const timestamp = formatTimestamp(new Date());

            // Local render
            messagesDiv.innerHTML += createMessageHtml({ content, timestamp }, true);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Send via socket
            socket.emit('send_message', {
                post_id: postId,
                content: content,
            });
            contentInput.value = '';
        }
    });

    // =================================================================
    // ### PHOTO UPLOAD LOGIC ###
    // =================================================================
    const uploadPhotoBtn = document.getElementById('upload-photo-btn');
    const fileUpload = document.getElementById('file-upload');

    // Trigger hidden file input when button is clicked
    uploadPhotoBtn.addEventListener('click', () => {
        fileUpload.click();
    });

    fileUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }

        // Check file size (e.g., limit to 5MB, 5 * 1024 * 1024 bytes)
        const MAX_FILE_SIZE = 5 * 1024 * 1024;
        if (file.size > MAX_FILE_SIZE) {
            alert('File size exceeds 5MB limit.');
            fileUpload.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
            const imageBase64 = event.target.result; // This is the data:image/... string
            const timestamp = formatTimestamp(new Date());

            // Local render: Use the imageBase64 string as content
            messagesDiv.innerHTML += createMessageHtml({ content: imageBase64, timestamp }, true);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Send image via socket
            socket.emit('send_message', {
                post_id: postId,
                content: imageBase64,
                is_image: true
            });

            // Clear the input so the same file can be uploaded again
            fileUpload.value = '';
        };

        // Read the file as a Data URL (Base64)
        reader.readAsDataURL(file);
    });

    // =================================================================
    // ### WHITEBOARD LOGIC (FIXED) ###
    // =================================================================
    const canvas = document.getElementById('whiteboard');
    const context = canvas.getContext('2d');
    const whiteboardModal = document.getElementById('whiteboard-modal');
    const openWhiteboardBtn = document.getElementById('open-whiteboard-btn');
    const closeWhiteboardBtn = document.getElementById('close-whiteboard-btn');

    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let currentColor = '#f5f5f5';

    // Set initial context properties
    context.lineCap = 'round';
    context.lineWidth = 4;

    function resizeCanvas() {
        // Temporarily store the image data
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

        // Sets the internal canvas resolution to match the size defined by CSS
        const w = canvas.clientWidth;
        const h = canvas.clientHeight;

        canvas.width = w;
        canvas.height = h;

        // Restore the image data (important for preserving the drawing)
        context.putImageData(imageData, 0, 0);

        // Re-apply context settings
        context.lineCap = 'round';
        context.lineWidth = 4;
    }

    // Call resize on window resize events (if modal is open)
    window.addEventListener('resize', () => {
        // Since we removed the opacity class, we just check if it's NOT hidden
        if (!whiteboardModal.classList.contains('hidden')) {
             resizeCanvas();
        }
    });

    function drawLine(x0, y0, x1, y1, color) {
        context.beginPath();
        context.moveTo(x0, y0);
        context.lineTo(x1, y1);
        context.strokeStyle = color;
        context.lineWidth = 4; // Ensure line width is always set
        context.stroke();
        context.closePath();
    }

    // Helper to get consistent coordinates for mouse/touch
    function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        // Use changedTouches for touchend, touches for touchmove/touchstart
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function handlePointerStart(e) {
        if (e.type === 'mousedown' && e.button !== 0) return;
        e.preventDefault(); // Prevent default browser actions like scrolling/text selection
        isDrawing = true;
        const coords = getCoords(e);
        [lastX, lastY] = [coords.x, coords.y];
        // Draw a single dot immediately on start
        drawLine(lastX, lastY, lastX + 0.1, lastY + 0.1, currentColor);
    }

    function handlePointerMove(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const coords = getCoords(e);
        const currentX = coords.x;
        const currentY = coords.y;

        // 1. Draw locally
        drawLine(lastX, lastY, currentX, currentY, currentColor);

        // 2. Send normalized coordinates (0 to 1) via socket
        socket.emit('drawing', {
            post_id: postId,
            x0: lastX / canvas.width,
            y0: lastY / canvas.height,
            x1: currentX / canvas.width,
            y1: currentY / canvas.height,
            color: currentColor
        });

        // 3. Update last position
        [lastX, lastY] = [currentX, currentY];
    }

    function handlePointerEnd() {
        if (isDrawing) {
            isDrawing = false;
        }
    }

    // Consolidated Event Listeners for Mouse and Touch
    canvas.addEventListener('mousedown', handlePointerStart);
    canvas.addEventListener('mousemove', handlePointerMove);
    canvas.addEventListener('mouseup', handlePointerEnd);
    canvas.addEventListener('mouseout', handlePointerEnd);

    canvas.addEventListener('touchstart', handlePointerStart);
    canvas.addEventListener('touchmove', handlePointerMove);
    canvas.addEventListener('touchend', handlePointerEnd);


    socket.on('drawing', (data) => {
        const w = canvas.width;
        const h = canvas.height;
        // Remote clients draw using received normalized coords * canvas size
        drawLine(data.x0 * w, data.y0 * h, data.x1 * w, data.y1 * h, data.color);
    });

    socket.on('clear_canvas', () => {
        context.clearRect(0, 0, canvas.width, canvas.height);
    });

    // Color Swatch Logic
    const colorSwatches = document.querySelectorAll('.color-swatch');
    colorSwatches.forEach(swatch => {
        swatch.addEventListener('click', () => {
            currentColor = swatch.dataset.color;
            colorSwatches.forEach(s => s.classList.remove('active'));
            swatch.classList.add('active');
        });
    });

    // Clear Button Logic
    document.getElementById('clear-btn').addEventListener('click', () => {
        // Local clear
        context.clearRect(0, 0, canvas.width, canvas.height);
        // Remote clear
        socket.emit('clear_canvas', { post_id: postId });
    });

    // ðŸš€ Modal Opening and Closing Logic (Simplified Fix) ðŸš€
    openWhiteboardBtn.addEventListener('click', () => {
        // 1. Make the modal visible immediately
        whiteboardModal.classList.remove('hidden');

        // 2. CRITICAL: Resize the canvas after the element is displayed
        setTimeout(() => {
            resizeCanvas();
        }, 50); // 50ms ensures the canvas size is correct
    });

    closeWhiteboardBtn.addEventListener('click', () => {
        // Hide the modal immediately
        whiteboardModal.classList.add('hidden');
    });

    // Close on backdrop click
    whiteboardModal.addEventListener('click', (e) => {
        if (e.target === whiteboardModal) {
            closeWhiteboardBtn.click(); // Reuse the close button logic
        }
    });
});
</script>
{% endblock %}