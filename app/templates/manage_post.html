{% extends 'base.html' %}

{% block content %}
<div class="max-w-3xl mx-auto bg-gradient-to-br from-violet-950 via-fuchsia-950 to-black rounded-3xl shadow-2xl p-8 mt-12 border-2 border-violet-800/80 backdrop-blur-md relative overflow-hidden">
    <div class="absolute -top-16 -right-16 opacity-10 pointer-events-none select-none">
        <svg width="300" height="300" fill="none"><circle cx="150" cy="150" r="130" stroke="#a78bfa" stroke-width="30" /></svg>
    </div>
    <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-violet-300 via-fuchsia-400 to-blue-400 mb-4 tracking-tight drop-shadow">Manage Applicants for: <span class="text-violet-200">{{ post.event_name }}</span></h1>
    <a href="{{ url_for('index') }}" class="text-violet-400 hover:underline mb-4 inline-block text-xs">&larr; Back to Posts</a>
    <div class="mb-8 flex flex-wrap gap-6 items-center justify-between">
        <div>
            <span class="font-semibold text-violet-200 text-xs">Team Members:</span>
            <ul class="flex flex-wrap gap-2 mt-2">
                {% for member in post.teammates %}
                    <li class="flex items-center gap-1 bg-violet-900/70 text-violet-100 px-3 py-1 rounded-full text-xs font-semibold border border-violet-800 shadow">
                        {% if member.profile.avatar_filename %}
                            <img src="{{ url_for('static', filename='avatars/' + member.profile.avatar_filename) }}" class="w-6 h-6 rounded-full object-cover border border-violet-700" alt="{{ member.username }}'s avatar">
                        {% else %}
                            <span class="w-6 h-6 flex items-center justify-center rounded-full bg-violet-800 text-violet-200 font-bold">{{ member.username[0]|upper }}</span>
                        {% endif %}
                        <span>{{ member.username }}{% if member == current_user %} (You){% endif %}</span>
                        {% if member == post.creator %}<span class="ml-1 bg-gradient-to-r from-fuchsia-700 to-violet-700 text-white px-2 py-0.5 rounded-full text-[10px] font-bold ml-2">Creator</span>{% endif %}
                    </li>
                {% else %}
                    <li class="text-violet-400 text-xs">No team members yet.</li>
                {% endfor %}
            </ul>
            {% if (post.male_slots or 0) + (post.female_slots or 0) > 0 %}
            <div class="mt-2 text-xs text-violet-400 font-semibold">
                Team Gender Ratio: <span class="text-violet-200">{{ post.male_slots or 0 }}M / {{ post.female_slots or 0 }}F</span>
            </div>
            {% endif %}
        </div>
        <div class="ml-auto flex flex-col gap-2 items-end">
            <form method="post">
                {% if post.applications_closed %}
                    <button name="open_applications" class="relative bg-gradient-to-r from-fuchsia-700 via-violet-800 to-violet-900 text-white px-4 py-2 rounded-xl shadow-lg text-xs font-bold hover:from-fuchsia-600 hover:to-violet-950 transition focus:outline-none focus:ring-2 focus:ring-fuchsia-400 overflow-hidden group" aria-label="Reopen applications">
                        <span class="z-10 relative">Reopen</span>
                        <span class="absolute inset-0 opacity-0 group-hover:opacity-30 transition bg-fuchsia-400 blur-xl animate-pulse"></span>
                    </button>
                {% else %}
                    <button name="close_applications" class="relative bg-gradient-to-r from-violet-800 via-fuchsia-900 to-black text-fuchsia-100 px-4 py-2 rounded-xl shadow-lg text-xs font-bold hover:from-violet-900 hover:to-black transition focus:outline-none focus:ring-2 focus:ring-violet-400 overflow-hidden group" aria-label="Close applications">
                        <span class="z-10 relative">Close</span>
                        <span class="absolute inset-0 opacity-0 group-hover:opacity-30 transition bg-violet-400 blur-xl animate-pulse"></span>
                    </button>
                {% endif %}
            </form>
            <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}" onsubmit="return confirm('Are you sure you want to delete this post? This action cannot be undone.');">
                <button type="submit" class="mt-2 bg-gradient-to-r from-red-700 via-fuchsia-900 to-black text-white px-4 py-2 rounded-xl shadow-lg text-xs font-bold hover:from-red-800 hover:to-black transition focus:outline-none focus:ring-2 focus:ring-red-400">
                    Delete Post
                </button>
            </form>
        </div>
    </div>
    <hr class="border-violet-900/40 mb-8">
    {% if recommended_users %}
    <h2 class="text-xl font-bold text-green-200 mb-4 flex items-center gap-2">
        <svg class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Recommended Users
    </h2>
    <div class="space-y-4 mb-10">
        {% for user in recommended_users %}
        <div class="flex flex-col md:flex-row gap-4 bg-gradient-to-br from-green-900/60 via-violet-900/60 to-black/60 rounded-xl p-4 border border-green-800/40 shadow">
            <div class="flex flex-col items-center md:items-start md:w-1/4">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-violet-900 to-black flex items-center justify-center border-2 border-green-700 shadow mb-2">
                    {% if user.profile.avatar_filename %}
                        <img src="{{ url_for('static', filename='avatars/' + user.profile.avatar_filename) }}" class="w-20 h-20 rounded-full object-cover" alt="{{ user.username }}'s avatar">
                    {% else %}
                        <span class="text-2xl text-green-300 font-bold">{{ user.username[0]|upper }}</span>
                    {% endif %}
                </div>
                <a href="mailto:{{ user.email }}" class="text-xs text-green-300 hover:underline break-all">{{ user.email }}</a>
            </div>
            <div class="flex-1">
                <a href="{{ url_for('user', username=user.username) }}" class="font-semibold text-green-200 hover:underline text-lg">{{ user.username }}</a>
                <div class="text-xs text-green-300 mt-1">
                    {{ user.profile.bio|default('No bio provided.', true) }}
                </div>
                <div class="text-xs text-green-400 mt-1">
                    <span class="font-semibold">College:</span> {{ user.profile.college or 'N/A' }}<br>
                    <span class="font-semibold">Year:</span> {{ user.profile.year or 'N/A' }}<br>
                    <span class="font-semibold">Degree:</span> {{ user.profile.degree or 'N/A' }}<br>
                    <span class="font-semibold">Location:</span> {{ user.profile.location or 'N/A' }}<br>
                    <span class="font-semibold">Gender:</span> {{ user.profile.gender or 'N/A' }}
                </div>
                <div class="text-xs text-green-400 mt-1">
                    <span class="font-semibold">Skills:</span> {% for skill in user.profile.skills %}<span class="inline-block bg-green-800/60 text-green-200 px-2 py-0.5 rounded-full mr-1 mb-1">{{ skill.name }}</span>{% endfor %}
                </div>
                <div class="text-xs text-green-400 mt-1 flex flex-wrap gap-2">
                    {% if user.profile.github_url %}
                        <a href="{{ user.profile.github_url }}" target="_blank" class="underline text-green-300">GitHub</a>
                    {% endif %}
                    {% if user.profile.linkedin_url %}
                        <a href="{{ user.profile.linkedin_url }}" target="_blank" class="underline text-green-300">LinkedIn</a>
                    {% endif %}
                    {% if user.profile.resume_file %}
                        <a href="{{ url_for('static', filename='resumes/' + user.profile.resume_file) }}" target="_blank" class="underline text-green-300">Resume</a>
                    {% endif %}
                </div>
            </div>
            <div class="flex flex-col justify-center items-center md:items-end md:w-1/6 mt-2 md:mt-0">
                <a href="{{ url_for('user', username=user.username) }}" class="px-4 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg text-xs font-bold shadow transition">View Profile</a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <hr class="border-violet-900/40 mb-8">
    <h2 class="text-xl font-bold text-violet-100 mb-4 flex items-center gap-2">
        <svg class="h-6 w-6 text-fuchsia-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 01.88 7.903A4.992 4.992 0 0112 21a4.992 4.992 0 01-4.88-6.097A4 4 0 118 7" /></svg>
        Applications
    </h2>
    {% if applications %}
        <div class="space-y-6">
            {% for app in applications %}
                <div class="bg-gradient-to-br from-black/90 via-[#1a1333]/90 to-[#3b197a]/90 rounded-2xl shadow-lg p-6 flex items-center justify-between swipe-card relative border-2 border-violet-900/60 transition-transform duration-200 group">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-violet-900 to-black flex items-center justify-center border-2 border-violet-700 shadow">
                            {% if app.applicant.profile.avatar_filename %}
                                <img src="{{ url_for('static', filename='avatars/' + app.applicant.profile.avatar_filename) }}" class="w-12 h-12 rounded-full object-cover" alt="{{ app.applicant.username }}'s avatar">
                            {% else %}
                                <span class="text-lg text-violet-300 font-bold">{{ app.applicant.username[0]|upper }}</span>
                            {% endif %}
                        </div>
                        <div>
                            <a href="{{ url_for('user', username=app.applicant.username) }}" class="font-semibold text-violet-200 hover:underline text-base">{{ app.applicant.username }}</a>
                            <div class="text-xs text-violet-400">{{ app.applicant.email }}</div>
                            <div class="text-xs text-violet-400">Status: <span class="font-semibold">{{ app.status }}</span></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        {% if app.status == 'Pending' %}
                        <form method="post" class="flex space-x-2 swipe-action-form" aria-label="Application actions for {{ app.applicant.username }}">
                            <input type="hidden" name="app_id" value="{{ app.id }}">
                            <button name="action" value="accept" class="relative flex items-center gap-1 bg-gradient-to-r from-fuchsia-700 via-violet-700 to-violet-900 text-white px-3 py-1.5 rounded-lg shadow-lg text-xs font-bold hover:from-fuchsia-600 hover:to-violet-950 transition focus:outline-none focus:ring-2 focus:ring-fuchsia-400 overflow-hidden group" aria-label="Accept application" title="Accept">
                                <svg class="h-4 w-4 z-10 relative" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                                <span class="z-10 relative">Accept</span>
                                <span class="absolute inset-0 opacity-0 group-hover:opacity-30 transition bg-fuchsia-400 blur-xl animate-pulse"></span>
                            </button>
                            <button name="action" value="reject" class="relative flex items-center gap-1 bg-gradient-to-r from-violet-800 via-black to-fuchsia-900 text-fuchsia-100 px-3 py-1.5 rounded-lg shadow-lg text-xs font-bold hover:from-violet-900 hover:to-black transition focus:outline-none focus:ring-2 focus:ring-violet-400 overflow-hidden group" aria-label="Reject application" title="Reject">
                                <svg class="h-4 w-4 z-10 relative" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                                <span class="z-10 relative">Reject</span>
                                <span class="absolute inset-0 opacity-0 group-hover:opacity-30 transition bg-violet-400 blur-xl animate-pulse"></span>
                            </button>
                        </form>
                        <div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none opacity-0 swipe-left-indicator transition-opacity duration-200">
                            <span class="bg-red-700 text-white px-2 py-1 rounded shadow text-xs">Reject</span>
                        </div>
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none opacity-0 swipe-right-indicator transition-opacity duration-200">
                            <span class="bg-green-700 text-white px-2 py-1 rounded shadow text-xs">Accept</span>
                        </div>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-lg bg-violet-900/60 text-violet-200 border border-violet-800 text-xs font-semibold">{{ app.status }}</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="bg-black/70 border border-violet-900 rounded-xl p-8 text-center">
            <p class="text-violet-400">No applications yet.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Swipe left/right to reject/accept
document.querySelectorAll('.swipe-card').forEach(function(card) {
    let startX = 0, currentX = 0, isDragging = false;
    let threshold = 80; // px
    let form = card.querySelector('.swipe-action-form');
    let leftIndicator = card.querySelector('.swipe-left-indicator');
    let rightIndicator = card.querySelector('.swipe-right-indicator');

    function setTransform(x) {
        card.style.transform = `translateX(${x}px)`;
        if (x < -threshold/2) {
            leftIndicator.style.opacity = 1;
        } else {
            leftIndicator.style.opacity = 0;
        }
        if (x > threshold/2) {
            rightIndicator.style.opacity = 1;
        } else {
            rightIndicator.style.opacity = 0;
        }
    }

    function resetTransform() {
        card.style.transform = '';
        leftIndicator.style.opacity = 0;
        rightIndicator.style.opacity = 0;
    }

    card.addEventListener('touchstart', function(e) {
        if (!form) return;
        isDragging = true;
        startX = e.touches[0].clientX;
    });
    card.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        setTransform(currentX - startX);
    });
    card.addEventListener('touchend', function(e) {
        if (!isDragging) return;
        isDragging = false;
        let diff = currentX - startX;
        if (diff < -threshold) {
            // Swipe left: reject
            form.querySelector('button[value="reject"]').click();
        } else if (diff > threshold) {
            // Swipe right: accept
            form.querySelector('button[value="accept"]').click();
        } else {
            resetTransform();
        }
    });
    // Mouse drag for desktop
    card.addEventListener('mousedown', function(e) {
        if (!form) return;
        isDragging = true;
        startX = e.clientX;
        card.style.transition = 'none';
    });
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        currentX = e.clientX;
        setTransform(currentX - startX);
    });
    document.addEventListener('mouseup', function(e) {
        if (!isDragging) return;
        isDragging = false;
        card.style.transition = '';
        let diff = currentX - startX;
        if (diff < -threshold) {
            form.querySelector('button[value="reject"]').click();
        } else if (diff > threshold) {
            form.querySelector('button[value="accept"]').click();
        } else {
            resetTransform();
        }
    });
});
</script>
{% endblock %}
