{% extends 'base.html' %}

{% block content %}

<div class="max-w-2xl mx-auto bg-black/80 rounded-2xl shadow-xl p-8 mt-8 border border-violet-900">
    <h1 class="text-3xl font-bold text-center text-violet-200 mb-10 tracking-tight">Edit Your Profile</h1>

    <form action="" method="post" novalidate enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="space-y-8">
            <div>
                <label class="block text-violet-200 text-sm font-semibold mb-2">Profile Picture</label>
                <div class="mt-2 flex items-center space-x-6">
                    <div class="flex-shrink-0">
                        {% if current_user.profile.avatar_filename %}
                            <img src="{{ url_for('static', filename='avatars/' + current_user.profile.avatar_filename) }}" alt="Current avatar" class="w-20 h-20 rounded-full object-cover border-2 border-violet-700 shadow-md">
                        {% else %}
                            <div class="w-20 h-20 bg-gradient-to-br from-violet-900 to-black rounded-full flex items-center justify-center border-2 border-violet-700">
                                <span class="text-2xl text-violet-300 font-bold">{{ current_user.username[0]|upper }}</span>
                            </div>
                        {% endif %}
                    </div>
                    <div class="w-full">
                        {{ form.avatar(class="block w-full text-sm text-violet-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-900/60 file:text-violet-200 hover:file:bg-violet-800/80 focus:outline-none") }}
                        {% for error in form.avatar.errors %}
                            <span class="text-red-400 text-xs mt-1">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div>
                {{ form.name.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                {{ form.name(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", placeholder="Your full name", value=current_user.profile.name or '') }}
            </div>
            <div>
                {{ form.bio.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                {{ form.bio(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", rows=4, placeholder="Tell us a little about yourself...") }}
            </div>
            <div>
                {{ form.skills.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                {{ form.skills(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", placeholder="Add skills...", value=current_user.profile.skills|map(attribute='name')|join(',')) }}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    {{ form.college.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                    {{ form.college(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", placeholder="e.g., University of Technology", value=current_user.profile.college or '') }}
                </div>
                <div>
                    {{ form.degree.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                    {{ form.degree(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", placeholder="e.g., B.S. in Computer Science", value=current_user.profile.degree or '') }}
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    {{ form.year.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                    {{ form.year(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", placeholder="e.g., Final Year", value=current_user.profile.year or '') }}
                </div>
                <div>
                    {{ form.location.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                    {{ form.location(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", placeholder="e.g., New Delhi, India", value=current_user.profile.location or '') }}
                </div>
            </div>
            <div>
                {{ form.github_url.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                {{ form.github_url(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", placeholder="https://github.com/username", value=current_user.profile.github_url or '') }}
            </div>
            <div>
                {{ form.linkedin_url.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                {{ form.linkedin_url(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600 placeholder-violet-400", placeholder="https://linkedin.com/in/username", value=current_user.profile.linkedin_url or '') }}
            </div>
            <div>
                {{ form.gender.label(class="block text-violet-200 text-sm font-semibold mb-2") }}
                {{ form.gender(class="w-full px-3 py-2 bg-black/60 border border-violet-800 rounded-lg text-violet-100 focus:outline-none focus:ring-2 focus:ring-violet-600") }}
            </div>

            <div class="border-t-2 border-violet-900/50 pt-8 space-y-4">
                <h3 class="text-lg font-semibold text-violet-200 tracking-wide">AI Skill Detection</h3>
                <p class="text-sm text-violet-300">Upload a certificate or resume (.pdf, .png, .jpg) to automatically add skills.</p>
                <div class="flex flex-col sm:flex-row items-center sm:space-x-4 space-y-4 sm:space-y-0">
                    <input type="file" id="skill-doc-uploader" class="block w-full text-sm text-violet-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-900/60 file:text-violet-200 hover:file:bg-violet-800/80 focus:outline-none">
                    <button type="button" id="detect-skills-btn" class="w-full sm:w-auto flex-shrink-0 bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:opacity-90 text-white font-bold py-2 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-black/80 focus:ring-fuchsia-500 transition-all duration-200">
                        Detect Skills
                    </button>
                </div>
                <div id="skill-detector-status" class="mt-2 text-sm h-5"></div>
            </div>
            <div class="pt-4">
                {{ form.submit(class="w-full bg-gradient-to-r from-violet-700 to-violet-900 hover:from-violet-800 hover:to-black text-white font-bold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-violet-600 focus:ring-offset-2 transition-all duration-200") }}
            </div>
        </div>
    </form>
</div>

<link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
<script src="https://unpkg.com/@yaireo/tagify"></script>
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>

<script>
    // The DOM element you wish to replace with Tagify
    var input = document.querySelector('input[name=skills]');

    // Initialize Tagify on the input element
    var tagify = new Tagify(input, {
        whitelist: [], // Start with an empty whitelist
        dropdown: {
            maxItems: 20,
            classname: "tags-look", // Custom class for dropdown
            enabled: 1,
            closeOnSelect: false
        }
    });

    // Listen to any keystroke which modifies the input
    tagify.on('input', onInput)

    function onInput( e ){
        var value = e.detail.value;
        tagify.whitelist = null;

        const controller = new AbortController();
        const signal = controller.signal;

        tagify.loading(true).dropdown.hide();

        fetch(`/api/skills/search?q=${value}`, {signal})
            .then(RES => RES.json())
            .then(function(newWhitelist){
                tagify.whitelist = newWhitelist;
                tagify.loading(false).dropdown.show(value);
            })
    }

    // --- JavaScript for Skill Detection API Call ---
    document.getElementById('detect-skills-btn').addEventListener('click', async () => {
        const uploader = document.getElementById('skill-doc-uploader');
        const statusDiv = document.getElementById('skill-detector-status');

        if (uploader.files.length === 0) {
            // MODIFICATION: Updated warning color
            statusDiv.innerHTML = '<span class="text-amber-400">Please select a file first.</span>';
            return;
        }

        // MODIFICATION: Updated analyzing/in-progress color
        statusDiv.innerHTML = '<span class="text-violet-400 animate-pulse">Analyzing document... please wait.</span>';

        const formData = new FormData();
        formData.append('file', uploader.files[0]);

        try {
            const response = await fetch('/api/detect-skills', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                if (result.skills.length > 0) {
                    // MODIFICATION: Updated success color
                    statusDiv.innerHTML = `<span class="text-emerald-400">Detected ${result.skills.length} skills! Added to your profile.</span>`;
                    tagify.addTags(result.skills); // Add detected skills to the input
                } else {
                    // MODIFICATION: Updated info color for no new skills
                    statusDiv.innerHTML = '<span class="text-violet-300">Analysis complete. No new skills were found.</span>';
                }
            } else {
                statusDiv.innerHTML = `<span class="text-red-400">Error: ${result.error}</span>`;
            }
        } catch (error) {
            statusDiv.innerHTML = '<span class="text-red-400">A network or server error occurred. Please try again.</span>';
            console.error('Skill detection error:', error);
        }
    });
</script>
{% endblock %}